<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPS Attendance â€¢ Developed by Haroon</title>
  <link rel="stylesheet" href="style.css">
  <script src="app.js" defer></script>
</head>

<body data-page="attendance">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo-section">
      <img src="./assets/logo.png" alt="Kcal Logo" class="sidebar-logo">
      <h2>KPS</h2>
      <p>Packaging System</p>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html">Dashboard</a>
      <a href="attendance.html" class="active">Attendance</a>
      <a href="overtime.html">Overtime</a>
      <a href="deduction.html">Deduction</a>
      <a href="employees.html">Employees</a>
      <a href="notifications.html">Notifications</a>
      <a href="request.html">Request</a>
      <a href="profile.html">Profile</a>
      <a href="#" data-logout>Logout</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Nav -->
    <header class="top-nav">
      <div class="top-nav-left">
        <h1>Attendance Management</h1>
        <p>Kcal Packaging System (KPS) â€” Developed by Haroon</p>
      </div>
      <div class="top-nav-right">
        <div class="user-info">
          <div class="user-avatar">SA</div>
          <div class="user-details">
            <span class="user-name">System Admin</span>
            <span class="user-role">Admin</span>
          </div>
          <div class="dropdown">
            <button class="dropdown-btn">â–¼</button>
            <div class="dropdown-menu">
              <a href="profile.html">Profile</a>
              <a href="#">Change Password</a>
              <a href="#" data-logout>Sign Out</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Attendance Controls -->
    <section class="attendance-actions">
      <h2>Mark Attendance</h2>
      <div class="action-buttons">
        <button id="checkInBtn" class="btn-primary" onclick="checkIn()">Check In</button>
        <button id="checkOutBtn" class="btn-secondary" onclick="checkOut()">Check Out</button>
        <button id="offDayBtn" class="btn-neutral" onclick="markOffDay()">Mark as Off Day</button>
        <button id="resetBtn" class="btn-danger" onclick="resetAttendance()">Reset Attendance</button>
      </div>
    </section>

    <!-- Attendance Table -->
    <section class="attendance-table-section">
      <h2>Todayâ€™s Attendance</h2>
      <table class="attendance-table">
        <thead>
          <tr>
            <th>UID</th>
            <th>Name</th>
            <th>Date</th>
            <th>Check In</th>
            <th>Check Out</th>
            <th>Total Duty</th>
            <th>Overtime (hrs)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="attendanceData">
          <!-- Rows inserted dynamically -->
        </tbody>
      </table>
    </section>

    <!-- Footer -->
    <footer>
      <p>Kcal Packaging System (KPS) â€” Developed by Haroon â€¢ All data confidential</p>
    </footer>
  </div>

  <!-- JS Logic -->
  <script>
    function getTodayDate() {
      const now = new Date();
      return now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Fetch Attendance Data
    function loadAttendance() {
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '[]');
      const tbody = document.getElementById('attendanceData');
      tbody.innerHTML = '';

      attendanceData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.uid}</td>
          <td>${row.name}</td>
          <td>${row.date}</td>
          <td>${row.in || '-'}</td>
          <td>${row.out || '-'}</td>
          <td>${row.duty || '-'}</td>
          <td>${row.ot || '-'}</td>
          <td>${row.status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Check In
    function checkIn() {
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '[]');
      const today = getTodayDate();

      if (attendanceData.some(a => a.date === today && a.in)) {
        alert('Already checked in today!');
        return;
      }

      const now = new Date();
      const record = {
        uid: '10001',
        name: 'System Admin',
        date: today,
        in: now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
        out: '',
        duty: '',
        ot: '',
        status: 'Checked In'
      };
      attendanceData.push(record);
      localStorage.setItem('attendance', JSON.stringify(attendanceData));
      loadAttendance();
      alert('Checked In Successfully âœ…');
    }

    // Check Out
    function checkOut() {
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '[]');
      const today = getTodayDate();
      const record = attendanceData.find(a => a.date === today && a.in);

      if (!record) {
        alert('Please Check In first!');
        return;
      }

      if (record.out) {
        alert('Already Checked Out!');
        return;
      }

      const now = new Date();
      record.out = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

      // Calculate duty and OT (10 hrs standard + 1 hr break)
      const inTime = new Date(`1970-01-01T${record.in}:00`);
      const outTime = new Date(`1970-01-01T${record.out}:00`);
      const diff = (outTime - inTime) / (1000 * 60 * 60);
      const dutyHours = Math.max(diff - 1, 0); // minus 1hr break
      const otHours = dutyHours > 10 ? (dutyHours - 10).toFixed(2) : 0;

      record.duty = dutyHours.toFixed(2);
      record.ot = otHours;
      record.status = 'Present';
      localStorage.setItem('attendance', JSON.stringify(attendanceData));
      loadAttendance();
      alert('Checked Out Successfully âœ…');
    }

    // Mark as Off Day
    function markOffDay() {
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '[]');
      const today = getTodayDate();

      attendanceData.push({
        uid: '10001',
        name: 'System Admin',
        date: today,
        in: '',
        out: '',
        duty: '0',
        ot: '0',
        status: 'Off Day'
      });
      localStorage.setItem('attendance', JSON.stringify(attendanceData));
      loadAttendance();
      alert('Marked as Off Day âœ…');
    }

    // Reset Attendance
    function resetAttendance() {
      const attendanceData = JSON.parse(localStorage.getItem('attendance') || '[]');
      const today = getTodayDate();
      const updated = attendanceData.filter(a => a.date !== today);
      localStorage.setItem('attendance', JSON.stringify(updated));
      loadAttendance();
      alert('Attendance for today has been reset ðŸ”„');
    }

    // Initialize
    window.onload = loadAttendance;
  </script>
</body>
</html>