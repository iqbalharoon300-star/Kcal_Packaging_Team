<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KPS – Employees</title>
  <link rel="stylesheet" href="style.css">
  <script src="app.js" defer></script>
</head>

<body data-page="employees">
  <!-- HEADER -->
  <header class="topbar">
    <div class="logo">Kcal Packaging System</div>
    <div class="user-info">
      <div class="user-avatar" id="profileTopAvatar"></div>
      <div class="user-meta">
        <span id="profileTopName"></span>
        <small id="profileTopRole"></small>
      </div>
      <div class="dropdown">
        <button class="dropdown-toggle">☰</button>
        <div class="dropdown-menu">
          <a href="profile.html">Profile</a>
          <a href="#" data-logout>Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Menu</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="attendance.html">Attendance</a>
    <a href="employees.html" class="active">Employees</a>
    <a href="overtime.html">Overtime</a>
    <a href="notifications.html">Notifications</a>
    <a href="request.html">Requests</a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <div class="page-header">
      <h1>Employee Directory</h1>
      <button class="btn-primary" id="btnAddEmployee" style="display:none;">+ Add Employee</button>
    </div>

    <table class="kps-table">
      <thead>
        <tr>
          <th>UID</th>
          <th>Name</th>
          <th>Role</th>
          <th>Section</th>
          <th>Shift</th>
          <th>Join Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody"></tbody>
    </table>
  </main>

  <!-- ADD / EDIT EMPLOYEE MODAL -->
  <div class="modal-overlay" id="employeeModal">
    <div class="modal">
      <h2 id="modalTitle">Add Employee</h2>
      <form id="employeeForm">
        <label>UID</label>
        <input type="text" id="empUID" required>

        <label>Name</label>
        <input type="text" id="empName" required>

        <label>Password</label>
        <input type="text" id="empPassword" placeholder="Default: User@123">

        <label>Role</label>
        <select id="empRole" required>
          <option value="Staff">Staff</option>
          <option value="Supervisor">Supervisor</option>
          <option value="Manager">Manager</option>
          <option value="Admin">Admin</option>
        </select>

        <label>Section</label>
        <input type="text" id="empSection" placeholder="e.g. Packaging">

        <label>Shift</label>
        <select id="empShift">
          <option value="Day">Day</option>
          <option value="Night">Night</option>
        </select>

        <label>Join Date</label>
        <input type="date" id="empJoinDate">

        <label>Email</label>
        <input type="email" id="empEmail" placeholder="name@kcallife.com">

        <label>Phone</label>
        <input type="tel" id="empPhone" placeholder="+971 50 000 0000">

        <div class="modal-actions">
          <button type="submit" class="btn-primary">Save</button>
          <button type="button" class="btn-cancel" id="closeModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</body>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const session = getSessionUser();
  if (!session) return;

  const tableBody = document.getElementById("employeeTableBody");
  const modal = document.getElementById("employeeModal");
  const form = document.getElementById("employeeForm");
  const btnAdd = document.getElementById("btnAddEmployee");
  const closeModal = document.getElementById("closeModal");
  let editMode = null;

  // Show Add button only for Admin / Manager / Supervisor
  const canManage = ["Admin", "Manager", "Supervisor"].includes(session.role);
  if (canManage) btnAdd.style.display = "inline-block";

  function renderEmployees() {
    const list = lsGet("kps_users", []);
    tableBody.innerHTML = "";
    list.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.uid}</td>
        <td>${u.name}</td>
        <td>${u.role}</td>
        <td>${u.section || "-"}</td>
        <td>${u.shift || "-"}</td>
        <td>${u.joinDate || "-"}</td>
        <td class="actions-cell">${
          canManage
            ? `
            <button class="btn-small btn-edit" data-uid="${u.uid}">Edit</button>
            <button class="btn-small btn-danger" data-del="${u.uid}">Delete</button>
            `
            : `<span class="readonly">View Only</span>`
        }</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  function openModal(editUID = null) {
    if (!canManage) return;
    modal.style.display = "flex";
    form.reset();
    editMode = null;
    if (editUID) {
      const users = lsGet("kps_users", []);
      const emp = users.find(x => x.uid === editUID);
      if (emp) {
        document.getElementById("modalTitle").textContent = "Edit Employee";
        document.getElementById("empUID").value = emp.uid;
        document.getElementById("empUID").disabled = true;
        document.getElementById("empName").value = emp.name;
        document.getElementById("empPassword").value = emp.password;
        document.getElementById("empRole").value = emp.role;
        document.getElementById("empSection").value = emp.section || "";
        document.getElementById("empShift").value = emp.shift || "Day";
        document.getElementById("empJoinDate").value = emp.joinDate || "";
        document.getElementById("empEmail").value = emp.email || "";
        document.getElementById("empPhone").value = emp.phone || "";
        editMode = emp.uid;
      }
    } else {
      document.getElementById("modalTitle").textContent = "Add Employee";
      document.getElementById("empUID").disabled = false;
    }
  }

  function closeModalWindow() {
    modal.style.display = "none";
  }

  if (canManage) {
    btnAdd.addEventListener("click", () => openModal());
    closeModal.addEventListener("click", closeModalWindow);
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    if (!canManage) return;

    const uid = document.getElementById("empUID").value.trim();
    const name = document.getElementById("empName").value.trim();
    const password = document.getElementById("empPassword").value.trim() || "User@123";
    const role = document.getElementById("empRole").value;
    const section = document.getElementById("empSection").value;
    const shift = document.getElementById("empShift").value;
    const joinDate = document.getElementById("empJoinDate").value;
    const email = document.getElementById("empEmail").value.trim();
    const phone = document.getElementById("empPhone").value.trim();

    const users = lsGet("kps_users", []);
    if (editMode) {
      const emp = users.find(x => x.uid === editMode);
      Object.assign(emp, { name, password, role, section, shift, joinDate, email, phone });
      lsSet("kps_users", users);
      pushNotification("Employee Updated", `${emp.name} (${emp.uid}) updated.`);
      showToast("Employee updated ✅");
    } else {
      if (users.find(u => u.uid === uid)) {
        showToast("UID already exists ❌", "error");
        return;
      }
      users.push({ uid, name, password, role, section, shift, joinDate, email, phone });
      lsSet("kps_users", users);
      pushNotification("Employee Added", `${name} (${uid}) added.`);
      showToast("Employee added ✅");
    }

    closeModalWindow();
    renderEmployees();
  });

  tableBody.addEventListener("click", e => {
    if (!canManage) return;
    if (e.target.dataset.uid) {
      openModal(e.target.dataset.uid);
    } else if (e.target.dataset.del) {
      const uid = e.target.dataset.del;
      if (confirm("Delete employee UID " + uid + "?")) {
        let list = lsGet("kps_users", []);
        list = list.filter(u => u.uid !== uid);
        lsSet("kps_users", list);
        pushNotification("Employee Deleted", `UID ${uid} removed.`);
        showToast("Employee deleted ❌", "info");
        renderEmployees();
      }
    }
  });

  renderEmployees();
});
</script>
</html>