{% extends "layout.html" %}
{% block content %}
  <h2>Overtime Records</h2>
  <div class="card">
  <div class="container mt-4">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title mb-3"><i class="bi bi-funnel"></i> Filter Overtime Records</h5>
      <form method="GET" action="/view_records" class="row g-3 align-items-end">

        <!-- 1️⃣ Date Filter -->
        <div class="col-md-3">
          <label for="date" class="form-label">Select Date</label>
          <input type="date" class="form-control" id="date" name="date" value="{{ request.args.get('date', '') }}">
        </div>

        <!-- 2️⃣ Employee Dropdown -->
        <div class="col-md-3">
          <label for="employee" class="form-label">Employee</label>
          <select class="form-select select2" id="employee" name="employee">
            <option value="">All Employees</option>
            {% for e in employees %}
              <option value="{{ e.name }}" {% if request.args.get('employee') == e.name %}selected{% endif %}>
                {{ e.code }} - {{ e.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- 3️⃣ Section Dropdown -->
        <div class="col-md-3">
          <label for="section" class="form-label">Section</label>
          <select class="form-select select2" id="section" name="section">
            <option value="">All Sections</option>
            {% for s in sections %}
              <option value="{{ s }}" {% if request.args.get('section') == s %}selected{% endif %}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Buttons -->
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Apply</button>
          <a href="/download_filtered?date={{ request.args.get('date', '') }}&employee={{ request.args.get('employee', '') }}&section={{ request.args.get('section', '') }}" class="btn btn-success w-100">
            <i class="bi bi-download"></i> Download
          </a>
        </div>

      </form>
    </div>
  </div>
</div>

 </form>
    <table class="records">
      <thead>
        <tr><th>Date</th><th>Employee</th><th>Code</th><th>Dept</th><th>Section</th><th>IN</th><th>OUT</th><th>Total</th><th>OT</th><th>Sign</th>{% if current_user.role in ['manager','supervisor'] %}<th>Actions</th>{% endif %}</tr>
      </thead>
      <tbody>
      {% for r in records %}
        <tr>
          <td>{{ r.date.strftime("%d %b %Y") }}</td>
          <td>{{ r.employee_name }}</td>
          <td>{{ r.employee_code }}</td>
          <td>{{ r.department }}</td>
          <td>{{ r.section }}</td>
          <td>{{ r.duty_in }}</td>
          <td>{{ r.duty_out }}</td>
          <td>{{ "%.2f"|format(r.total_hours) }}</td>
          <td>{{ "%.2f"|format(r.overtime_hours) }}</td>
          <td>{{ r.sign_of_incharge }}</td>
          {% if current_user.role in ['manager','supervisor'] %}
          <td><a class="btn small" href="{{ url_for('edit_record', rec_id=r.id) }}">Edit</a>
              <form method="POST" action="{{ url_for('delete_record', rec_id=r.id) }}" style="display:inline" onsubmit="return confirm('Delete this record?')">
                <button class="btn small danger" type="submit">Delete</button>
              </form></td>
          {% endif %}
        </tr>
      {% else %}
        <tr><td colspan="11">No records found.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
